{% extends "main/base.html" %}
{% load static %}

{% block content %}
<!--==============================
    Breadcumb
    ============================== -->
<div class="breadcumb-wrapper" data-bg-src="{% static 'main/img/breadcumb/breadcumb-bg.png' %}">
  <div class="container z-index-common">
    <div class="breadcumb-content">
      <h1 class="breadcumb-title">Volunteer Plant ID</h1>
    </div>
    <div class="breadcumb-menu-wrap">
      <ul class="breadcumb-menu">
        <li><a href="index-2.html">Home</a></li>
        <li>Volunteer Plant ID</li>
      </ul>
    </div>
  </div>
</div>

<!--==============================
			voluntary area Area
	==============================-->
<section class="volunteer-form-section py-5">
  <div class="container">
    <div class="text-center mb-5">
      <h2 class="display-6 fw-bold text-dark">üåæ Volunteer Plant Identifier</h2>
      <p class="text-muted fs-5">Upload a photo to identify unexpected or volunteer plants in your field.</p>
    </div>

    <!-- Form Section -->
    <div id="form-section" class="form-card p-5 mx-auto text-center">
      <form id="volunteerForm" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="mb-4">
          <label for="volunteerImage" class="form-label fw-semibold">üì∏ Upload Plant Image</label>
          <div class="upload-box mx-auto" onclick="document.getElementById('volunteerImage').click();">
            <i class="bi bi-cloud-upload-fill fs-1 text-success"></i>
            <p class="mt-2 text-muted">Click to upload or drag a file here</p>
            <input type="file" class="form-control visually-hidden" id="volunteerImage" name="volunteerImage"
              accept="image/*" required>
            <img id="volunteerPreview" class="img-fluid mt-3 d-none rounded shadow-sm" style="max-height: 200px;" />
          </div>
        </div>

        <button type="submit" class="btn btn-success px-5 py-2 fs-5 fw-semibold shadow">
          <span id="submit-text">üîç Identify Plant</span>
          <span id="loading-spinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status"
            aria-hidden="true"></span>
        </button>
      </form>
    </div>

    <!-- Result Section -->
    <div id="result-section" style="display: none;" class="container mt-5">
      <div class="row">
        <!-- Left Column: Image + Names -->
        <div class="col-4">
          <img id="result-image" style="margin-right: 50px;" class="img-fluid rounded mb-3"
            style="max-height: 300px;" />
          <div class="mb-2">
            <strong class="title">Scientific Name:</strong> <span class="name_info" id="scientific-name"></span>
          </div>
          <div class="mb-2">
            <strong class="title">Common Name:</strong> <span class="name_info" id="common-name"></span>
          </div>
        </div>

        <!-- Right Column: Type, Description, Solution -->
        <div class="col-8">
          <div class="mb-3">
            <span class="plantType" id="plant-type"></span>
          </div>
          <div class="mb-3">
            <strong class="title">Description</strong>
            <p id="description"></p>
          </div>
          <div class="mb-3">
            <strong class="title">How to Handle</strong>
            <ul id="solution" class="text-start"></ul>
          </div>
          <!-- Button Section -->
          <div class="mb-3 d-flex justify-content-end">
            <button type="button" class="btn btn-success" onclick="window.location.reload()">
              Analyze Another Plant
            </button>
          </div>
        </div>
      </div>

    </div>
  </div>
</section>



<style>
  .upload-box {
    padding: 2rem;
    background-color: #f9f9f9;
    border: 2px dashed #ccc;
    border-radius: 15px;
    cursor: pointer;
    transition: background 0.3s ease, border-color 0.3s ease;
    max-width: 100%;
  }

  .upload-box:hover {
    background-color: #e8f5e9;
    border-color: #198754;
  }

  .form-card {
    max-width: 600px;
    background: #ffffff;
    border-radius: 20px;
    box-shadow: 0 20px 50px rgba(0, 128, 0, 0.1);
    animation: fadeSlideIn 0.6s ease-out forwards;
    opacity: 0;
    transform: translateY(40px);
  }

  .title {
    font-size: large;
    font-weight: 800;
    color: #0d462b;
  }

  .name_info {
    font-size: large;
    font-weight: 300;
    color: #000000;
  }

  .plantType {
    padding: 12px 24px;
    border-radius: 15px;
    background-color: #ddd;
    color: #333;
    font-weight: bold;
    font-size: 1.1rem;
    /* Increased font size */
    display: flex;
    /* For centering */
    align-items: center;
    /* Vertically center */
    justify-content: center;
    transition: background-color 0.3s ease, color 0.3s ease;
    text-align: center;
    flex: 1;
    /* Add fixed size */
    width: 200px;
    height: 50px;
  }

  @keyframes fadeSlideIn {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>



{% endblock %}


{% block java%}

<script>
  function getCSRFToken() {
    const cookieValue = document.cookie.match('(^|;)\\s*csrftoken\\s*=\\s*([^;]+)');
    return cookieValue ? cookieValue.pop() : '';
  }
  document.getElementById('volunteerImage').addEventListener('change', function (event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function (e) {
        const preview = document.getElementById('volunteerPreview');
        preview.src = e.target.result;
        preview.classList.remove('d-none');
      };
      reader.readAsDataURL(file);
    }
  });

  document.getElementById('volunteerForm').addEventListener('submit', async function (e) {
    e.preventDefault();

    const form = e.target;
    const formData = new FormData(form);

    try {
      const response = await fetch('/voluntary/', {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCSRFToken(),
        },
        body: formData
      });

      if (!response.ok) {
        const errorData = await response.json();
        console.error('Error details:', errorData);
        throw new Error(errorData.message || 'Failed to identify plant ');
      }

      const data = await response.json();

      // Show results
      document.getElementById('form-section').style.display = 'none';
      document.getElementById('result-section').style.display = 'block';
      document.getElementById('result-image').src = data.image_url;
      document.getElementById('scientific-name').textContent = data.scientific_name;
      document.getElementById('plant-type').textContent = data.Type;
      document.getElementById('common-name').textContent = data.Common_name;
      document.getElementById('description').textContent = data.Description;
      const solutionList = document.getElementById('solution');
      solutionList.innerHTML = ''; // Clear previous content

      data.Solution.forEach(step => {
        const li = document.createElement('li');
        li.textContent = step;
        solutionList.appendChild(li);
      });


    } catch (error) {
      console.error('Error:', error);
      alert(`Error: ${error.message}. Please check console for details.`);
    }
  });
</script>
<script src="{% static 'main/js/vendor/jquery-3.6.0.min.js' %}"></script>
<script src="{% static 'main/js/slick.min.js' %}"></script>
<script src="{% static 'main/js/bootstrap.min.js' %}"></script>
<script src="{% static 'main/js/jquery.magnific-popup.min.js' %}"></script>
<script src="{% static 'main/js/imagesloaded.pkgd.min.js' %}"></script>
<script src="{% static 'main/js/isotope.pkgd.min.js' %}"></script>
<script src="{% static 'main/js/main.js' %}"></script>
{% endblock %}
